#!/bin/bash -eux

TO="$1"
UNIT="$2"

CMD="systemctl --user status --full $UNIT"

set +e
STATUS="$($CMD)"
set -e

# eh. not very atomic..

TS="$(systemctl --user show -p ActiveEnterTimestamp --value "$UNIT")"
LOGS="$(journalctl -u "$UNIT" --since "$TS")"


# TODO FIXME make sure that we get some warning if the mailer itself fails?
# systemctl --user show --value -p InvocationID systemdtab-test.service

# TODO indicate if it failed?
# TODO suggest how to inspect logs, include tail or link??
# TODO ugh!
sendmail -t <<ERRMAIL
To: $TO
From: systemd <root@$HOSTNAME>
Subject: $UNIT
Content-Transfer-Encoding: 8bit
Content-Type: text/plain; charset=UTF-8

$CMD

$STATUS

$LOGS

ERRMAIL
